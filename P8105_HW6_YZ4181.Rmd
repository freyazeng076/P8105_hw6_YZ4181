---
title: "P8105_HW6_YZ4181"
author: "Yuanyuan Zeng(yz4181)"
date: "11/30/2021"
output: github_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)

library(tidyverse)
library(modelr)
library(mgcv)
```

## Problem 1
```{r}
birthweigh = read_csv("./birthweight.csv") %>% 
  mutate(
    babysex = recode(babysex, `1` = "male", `2` = "female"),
    babysex = factor(babysex),
    frace = recode(frace, 
                   `1` = "White",
                   `2` = "Black",
                   `3` = "Asian",
                   `4` = "Peutro",
                   `8` = "Other"),
    frace = factor(frace),
    mrace = recode(mrace,
                   `1` = "White",
                   `2` = "Black",
                   `3` = "Asian",
                   `4` = "Peutro",
                   `8` = "Other" ),
    mrace = factor(mrace),
    malform = recode(malform, `0` = "Absent", `1` = "Present"),
    malform = factor(malform))

head(birthweigh,10)

# check for missing value
skimr::skim(birthweigh)
```
* The original data set includes 4342 observations and 20 variables. There is no missing value. The variable of baby sex, father race, mother race, and malformations are re-coded based on the information and converted into factors. Other variables remain as numeric.


#### Propose regression model
```{r}
propose_model= lm(bwt ~ blength + delwt + babysex, data = birthweigh) # regression model

propose_model %>% broom::tidy() %>% 
  select(term, estimate, p.value) %>% 
  mutate(
    term = replace(term, term == "blength", "baby's length"),
    term = replace(term, term == "delwt", "mother's weight at delivery"),
    term = replace(term, term == "babysexmale", "baby sex (male)")
  ) %>% 
  knitr::kable(digits = 3)
```
* The birth weight of the baby depends on baby's length at birth, baby's sex and mother's weight at delivery. We assume there is no interaction between the predictors. Increasing in one unit of length leads to increase baby weight by 134.276 grams. One unit increase of mother's weight at delivery leads to increase baby weight by 2.862 grams. Being males increases weight by 9.658 grams comparing with females.

#### Diagnostics
```{r}
birthweigh %>% 
  modelr::add_residuals(propose_model) %>% 
  modelr::add_predictions(propose_model) %>% 
  ggplot(aes(x = pred, y = resid))+
  geom_point()+
  facet_grid(~babysex)+
  labs(
    x = "Fitted Value",
    y = "Residuals",
    title = "Plot of Residuals against Fitted Value"
  )
```

* The plot shows that the residuals randomly fall around 0 for both female and male. There are some points that deviate from 0 which mean that those points are away from the fitted values.

#### Comparing proposed model with two other models
```{r}
# Select the variables needed for three models
birthweigh = birthweigh %>% 
  select(bwt, blength, babysex, delwt, gaweeks, bhead)

# Perform training/testing split
cv_df = 
  crossv_mc(birthweigh, 100) %>% 
  mutate(train = map(train, as_tibble),
         test = map(test, as_tibble))

# Calculate the rmse for three models
cv_df = cv_df %>% 
  mutate(
    proposed_mod = map(.x = train, ~lm(bwt ~ blength + babysex + delwt, data = .x)),
    mod2 = map(.x = train, ~lm(bwt ~ blength + gaweeks, data = .x)),
    mod3 = map(.x = train, ~lm(bwt ~ bhead * blength + babysex * blength + bhead * blength * babysex, data = .x ))) %>% 
  mutate(
    rmse_proposed_mod = map2_dbl(.x = proposed_mod, .y = test, ~rmse(model = .x, data = .y)),
    rmse_mod2 = map2_dbl(.x = mod2, .y = test, ~rmse(model = .x, data = .y)),
    rmse_mod3 = map2_dbl(.x = mod3, .y = test, ~rmse(model = .x, data = .y)))

# Show the rmse in plot
cv_df %>% 
  select(.id, starts_with("rmse")) %>% 
  pivot_longer(
    rmse_proposed_mod:rmse_mod3,
    values_to = "rmse",
    names_to = "model",
    names_prefix = "rmse_") %>% 
  mutate(
    model = fct_inorder(model)
  ) %>% 
  ggplot(
    aes(x = model, y = rmse)) + geom_boxplot() +
  labs(titble = "Boxplot of rmse for three models")
```

* According to the boxplot, model3 (using head circumference, length, sex, and all interactions) has lowest rmse which means that model3 has a lowest prediction error among three models. Therefore, model3 is better compared with proposed model and model2.


## Problem 2
```{r}
weather_df = 
  rnoaa::meteo_pull_monitors(
    c("USW00094728"),
    var = c("PRCP", "TMIN", "TMAX"), 
    date_min = "2017-01-01",
    date_max = "2017-12-31") %>%
  mutate(
    name = recode(id, USW00094728 = "CentralPark_NY"),
    tmin = tmin / 10,
    tmax = tmax / 10) %>%
  select(name, id, everything())
```

#### Bootstrap sample
```{r}
boots_straps = weather_df %>% modelr::bootstrap(n = 5000) %>% 
  mutate(
    models = map(.x = strap, ~lm(tmax ~ tmin, data = .x)),
    results1 = map(models, broom::glance)
  ) %>% 
  select(-strap, -models) %>% 
  unnest(results1) %>% 
  select(.id, r.squared)
  
boots_straps %>% ggplot(aes(x = r.squared)) + geom_density()
```

